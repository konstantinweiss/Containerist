<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" media="all" href="{{skin}}stack.css" />
  <link rel="stylesheet" type="text/css" media="all" href="/{{module_dir}}res/page-admin.css" />
  <link rel="stylesheet" type="text/css" media="all" href="/{{module_dir}}res/style.css" />
</head>

<body onLoad="document.form.source.focus()">

  <section class="container ctn">
    {{#stack}}
    <div class="D1 C1 B1 A1">
      <a href="{{stack}}"class="btn">back</a>
    </div>
    {{/stack}}

    <div class="D9 C8 B8 A4">

      {{#edit_origin}}
      <form id="origin_form" name="origin_form" action="/{{repo}}/storer-rename.mod" method="GET">
        <input name="old_id" value="{{id}}" type="hidden" class="form-text" />
        Container ID: 
        <input name="new_id" value="{{id}}" size="40" class="form-text" />
        <input type="submit" name="submit" value="change" size="10" class="btn"/>
        <span id="origin_response"></span>
      </form>
      <br><br>
      {{/edit_origin}}

      <form id="form" name="form" action="./" method="POST">
        <div id="params">
          <input type="hidden" name="id" value="{{id}}" class="form-text" />
          <input type="hidden" name="module" value="{{module}}" class="form-text" />
        </div>
        <textarea name="source">{{{source}}}</textarea>
      </form>
    </div>

      <div class="D4 C2 B0 A0">
        <p>Used in stacks:</p>
        <ul>
          {{#usage}}
          <li><a href="{{ . }}">{{ . }}</a></li>
          {{/usage}}
        </ul>
      </div>
  </section>

  <div id="rendered_container">
  </div>

</body>

<script type="text/javascript" src="/{{module_dir}}res/jquery.min.js"></script>
<script>

// jquery executes this function, once the DOM is ready.
$(function() {

    $('#origin_form [name=new_id]').focusout(handle_origin_form);
    var origin_form = {
      origin_form: $('#origin_form'),
      new_id:      $('#origin_form [name=new_id]'),
    };
    var origin_notice = $('#origin_response');
    var origin_button = $('#origin_form [name=submit]');
    origin_button.hide();

    $('#origin_form [name=new_id]').keyup(reset_origin_timer);

    // timer
    to = null;
    reset_origin_timer();
    function reset_origin_timer() {
      clearTimeout(to);
      to = setTimeout(handle_origin_form, 500);
    }

    function handle_origin_form(event) {
      var php_get = '/{{repo}}/storer-exists.mod',
          php_load = '/{{repo}}/storer-exists.mod?id='+origin_form.new_id.val(),
          data_to_php = {
            id: origin_form.new_id.val()
          },
          callback = function(response) {
//            preview_div.load(php_load, data_to_php);
            origin_response (response);
          };
      // filename, data to php, callback when php finishes
       $.get(php_get, data_to_php, callback, 'json');
    }

    function origin_response(response) {
      console.log (response);
      if (response) {
        origin_button.hide();
        origin_notice.show();
        origin_notice.html ('<a href="/{{repo}}/'+origin_form.new_id.val()+'.ctn">view source</a>');
      } else {
        origin_button.show();
        origin_notice.hide();
      }
    }



    $('#form [name=source]').focusout(handle_form);
    var form = {
      form:   $('#form'),
      id:     $('#form [name=id]'),
      module: $('#form [name=module]'),
      source: $('#form [name=source]')
    };
    var preview_div = $('#rendered_container');

    $('#form [name=source]').keyup(reset_timer);

    // timer
    tn = null;
    reset_timer();
    function reset_timer() {
      clearTimeout(tn);
      tn = setTimeout(handle_form, 500);
    }

    function handle_form(event) {
      console.log (form.id.val());
      var php_get = '/{{repo}}/storer-update.mod',
          php_load = '{{site}}{{id}}.ctn.html',
          data_to_php = {
            id:     form.id.val(),
            module: form.module.val(),
            source: form.source.val()
          },
          callback = function(response) {
            preview_div.load(php_load, data_to_php);
          };
      // filename, data to php, callback when php finishes
      $.get(php_get, data_to_php, callback);
    }

});


</script>
</html>